# 23-构建无障碍的表单

表单是 Web 应用中交互最复杂、也最容易出现可访问性问题的部分。构建一个无障碍的表单，是对我们前面所学知识的一次综合运用，是 A11y 实践的试金石。

一个无障碍的表单不仅能被所有人使用，通常也意味着它拥有更清晰的结构、更友好的用户体验和更健壮的代码。

## 1. 基础：为每个控件提供明确的 `<label>`

我们再次强调这个基础，因为它是不可或缺的。每个 `<input>`, `<textarea>`, `<select>` 都必须有一个与之程序化关联的 `<label>`。

```html
<label for="name">姓名:</label>
<input type="text" id="name" name="name">
```

## 2. 分组相关控件：`<fieldset>` 与 `<legend>`

当一组控件在功能上属于同一个问题时（最常见的是单选按钮组或复选框组），应该使用 `<fieldset>` 将它们包裹起来，并使用 `<legend>` 为整个组提供一个标题。

*   **`<fieldset>`**: 将相关的表单控件组合在一起。
*   **`<legend>`**: 为 `fieldset` 提供一个标题。这个标题对于屏幕阅读器用户至关重要，因为当他们聚焦到组内的任何一个控件时，屏幕阅读器都会读出这个标题，为用户提供必要的上下文。

**示例：单选按钮组**
```html
<fieldset>
  <legend>请选择您的配送方式：</legend>

  <input type="radio" id="standard" name="shipping" value="std" checked>
  <label for="standard">标准配送</label>

  <input type="radio" id="express" name="shipping" value="exp">
  <label for="express">加急配送</label>
</fieldset>
```
在这个例子中，当用户聚焦到“加急配送”时，屏幕阅读器可能会读出：“单选按钮，未选中，加急配送，2之2，位于‘请选择您的配送方式：’分组中”。

## 3. 实时验证与错误处理

这是表单可访问性中最具挑战性也最重要的部分。一个无障碍的错误提示流程应该满足：

1.  **明确指出**哪个字段有误。
2.  **清晰描述**错误的原因。
3.  **方便用户**定位并修正错误。

### a. 传达无效状态：`aria-invalid`

当一个字段验证失败时，应该动态地为其添加 `aria-invalid="true"` 属性。这会向辅助技术明确地宣告“这个字段当前是无效的”，屏幕阅读器通常会用特殊的音调或词语（如“invalid”）来提示用户。

### b. 关联错误信息：`aria-describedby`

错误信息通常是动态出现在输入框下方或旁边的。为了让屏幕阅读器知道这条错误信息是属于哪个输入框的，我们需要使用 `aria-describedby` 属性将它们进行“语义绑定”。

*   `aria-describedby` 的值应该指向包含错误信息的那个元素的 `id`。

**示例：将错误信息与输入框关联**
```html
<label for="email">邮箱地址:</label>
<input type="email" id="email" name="email" aria-describedby="email-error" aria-invalid="true">
<div id="email-error" class="error-message">
  请输入一个有效的邮箱地址。
</div>
```
在这个例子中，当用户聚焦到输入框时，屏幕阅读器不仅会读出 `label`（“邮箱地址”），还会读出 `aria-describedby` 指向的错误信息（“请输入一个有效的邮箱地址”），从而让用户立即了解问题所在。

## 4. 提交后的反馈与焦点管理

### a. 提交反馈：ARIA Live Regions

当用户提交表单后，无论成功还是失败，都应该给予清晰的反馈。对于这些动态出现的反馈信息，我们应该使用上一节学到的 **ARIA Live Regions** (`aria-live`) 来确保屏幕阅读器能够自动朗读。

```html
<div id="form-feedback" aria-live="polite" role="status"></div>
```

### b. 失败后的焦点管理

如果表单提交因多个字段错误而失败，最佳实践是：
1.  在页面顶部（或表单的 `legend` 下方）显示一个**错误摘要**，列出所有错误并提供跳转到对应字段的链接。
2.  **将键盘焦点**用 JavaScript (`.focus()`) 主动移动到这个错误摘要区域，让用户第一个听到的就是表单的整体状况。

另一种简化方案是，将焦点移动到**第一个**带有 `aria-invalid="true"` 的表单控件上。

## 5. 完整示例：一个无障碍的注册表单

```html
<form novalidate>
  <div id="form-error-summary" role="group" aria-labelledby="error-heading" tabindex="-1">
    <h2 id="error-heading">表单中有 2 个错误</h2>
    <ul>
      <li><a href="#name">姓名不能为空</a></li>
      <li><a href="#email">请输入有效的邮箱地址</a></li>
    </ul>
  </div>

  <div>
    <label for="name">姓名:</label>
    <input type="text" id="name" name="name" required aria-invalid="true" aria-describedby="name-error">
    <span id="name-error" class="error-message">姓名不能为空</span>
  </div>

  <div>
    <label for="email">邮箱地址:</label>
    <input type="email" id="email" name="email" required aria-invalid="true" aria-describedby="email-error">
    <span id="email-error" class="error-message">请输入有效的邮箱地址</span>
  </div>
  
  <fieldset>
    <legend>您是否愿意接收我们的资讯邮件？</legend>
    <input type="radio" id="yes" name="newsletter" value="yes">
    <label for="yes">是</label>
    <input type="radio" id="no" name="newsletter" value="no" checked>
    <label for="no">否</label>
  </fieldset>

  <button type="submit">注册</button>
</form>

<div id="form-success-feedback" aria-live="polite" role="alert">
  <!-- 注册成功后，JS 在此填入 "注册成功！" -->
</div>

<script>
  // 伪代码：表单提交逻辑
  const form = document.querySelector('form');
  form.addEventListener('submit', (event) => {
    event.preventDefault();
    const isFormValid = validateForm(); // 假设这是你的验证函数
    
    if (!isFormValid) {
      // 验证失败，显示错误摘要并聚焦
      const errorSummary = document.getElementById('form-error-summary');
      errorSummary.style.display = 'block';
      errorSummary.focus();
    } else {
      // 验证成功，显示成功信息
      const successFeedback = document.getElementById('form-success-feedback');
      successFeedback.textContent = '注册成功！感谢您的加入。';
    }
  });
</script>
```

这个示例综合运用了本章的各项技术，构建了一个既对普通用户友好，也对使用辅助技术的用户完全可访问的健壮表单。
