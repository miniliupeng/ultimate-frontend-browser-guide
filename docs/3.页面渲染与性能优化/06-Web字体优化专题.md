# 12-Web 字体优化专题

自定义 Web 字体是提升网站设计感和品牌辨识度的重要手段，但它们也是常见的性能瓶颈。字体文件通常体积较大，且属于高优先级资源，它们的加载策略直接影响到 **FCP (首次内容绘制)**、**LCP (最大内容绘制)** 和 **CLS (累积布局偏移)** 等核心性能指标。

## 1. 字体加载引发的问题

浏览器在渲染文本时，如果发现指定的 `@font-face` 字体尚未下载完成，就会面临一个两难的抉择，从而导致两种不佳的用户体验：

### a. FOIT (Flash of Invisible Text) - 不可见文本闪烁

*   **现象**：浏览器会**等待**字体文件下载完成，在此期间，使用该字体的文本将是**完全不可见的**。这会导致用户在一段时间内（通常最多 3 秒）看不到任何文字内容，严重影响 LCP。
*   **原因**：这是许多浏览器的默认行为，旨在避免显示未样式化的文本。

### b. FOUT (Flash of Unstyled Text) - 无样式文本闪烁

*   **现象**：浏览器会立即使用一个**备用字体**（如系统默认字体）来显示文本。当自定义字体下载完成后，文本会突然**切换**成新的字体，导致页面内容“闪烁”一下，并可能引发布局偏移（CLS）。
*   **原因**：这是一种“先内容后样式”的策略。

我们的优化目标就是：**尽可能快地加载字体，并有效控制 FOIT 和 FOUT，找到性能和视觉体验的最佳平衡点。**

## 2. 核心优化策略：`font-display`

`font-display` 是一个 `@font-face` 规则中的 CSS 描述符，它允许我们控制字体在下载期间的显示行为，是字体优化的**核心属性**。

```css
@font-face {
  font-family: 'MyFont';
  src: url('/my-font.woff2') format('woff2');
  font-display: swap; /* 核心在这里 */
}
```

`font-display` 属性有五个值，对应不同的策略：

| 值          | **阻塞期 (Block)**                                  | **交换期 (Swap)**                                       | **失败期 (Failure)**                    | **总结与建议**                                           |
| ----------- | --------------------------------------------------- | ------------------------------------------------------- | --------------------------------------- | -------------------------------------------------------- |
| `auto`      | 由浏览器决定 (通常类似 `block`)                     | -                                                       | -                                       | 不推荐，行为不确定                                       |
| **`block`** | **较短** (约 3s)，文本不可见 (FOIT)                  | **无限长**，下载完后立即交换 (FOUT)                       | 使用备用字体                            | 适用于字体是核心体验、不可替代的场景（如 Logo 字体） |
| **`swap`**  | **极短** (约 100ms)，几乎立即显示备用字体          | **无限长**，下载完后立即交换 (FOUT)                       | 使用备用字体                            | **推荐！** 优先保证内容可读性，能最快地显示文本      |
| **`fallback`**| **极短** (约 100ms)，几乎立即显示备用字体          | **较短** (约 3s)，在此期间下载完才交换，否则不交换        | 使用备用字体                            | 在弱网环境下，宁愿放弃自定义字体也要保证视觉稳定性     |
| **`optional`**| **极短** (约 100ms)，几乎立即显示备用字体          | **不交换**。浏览器会继续下载，但只在下次导航时使用      | 使用备用字体                            | 字体为非必需品，内容可读性远比自定义字体重要             |

**最佳实践**：对于绝大多数 Web 内容，`font-display: swap;` 是最实用、最平衡的选择。它能最快地让用户看到内容，有效优化 FCP 和 LCP。

## 3. 加快字体加载速度

### a. 预加载关键字体 (Preload)

如果一个字体文件对于首屏渲染至关重要（例如用于标题），我们可以使用 `<link rel="preload">` 来告知浏览器**以高优先级立即下载**它，从而缩短字体的阻塞时间。

```html
<head>
  <link rel="preload" href="/my-font.woff2" as="font" type="font/woff2" crossorigin>
</head>
```
*   `as="font"`: 明确告知浏览器这是一个字体文件。
*   `type="font/woff2"`: 帮助浏览器确认文件类型。
*   `crossorigin`: 必须添加，因为字体请求通常是跨域的。

### b. 使用现代字体格式：WOFF2

WOFF2 (Web Open Font Format 2) 是目前压缩率最高、性能最好的 Web 字体格式，其体积通常比 WOFF 或 TTF 小 30% 左右。应始终优先使用 WOFF2。

```css
@font-face {
  font-family: 'MyFont';
  /* 优先加载 WOFF2 */
  src: url('my-font.woff2') format('woff2'),
       /* 为旧浏览器提供 WOFF 作为回退 */
       url('my-font.woff') format('woff');
  font-display: swap;
}
```

### c. 字体子集化 (Subsetting)

一个完整的字体文件可能包含数千个字符，但你的网站可能只需要其中的一小部分（例如，基本的拉丁字母、数字和标点符号）。**字体子集化**就是从字体文件中**剔除那些你用不到的字符**，从而生成一个体积更小的定制化字体文件。

**这是字体优化中最有效、最重要的手段之一，可以极大地减小字体文件的体积。**

**如何实现**：
*   **Google Fonts**: 如果你使用 Google Fonts, 它会自动进行子集化。你可以在请求 URL 中通过 `text` 参数指定你需要的字符，例如 `&text=HelloWorld`。
*   **本地工具**: 可以使用 `font-spider` (字蛛，适合中文字体) 或 `pyftsubset` (FontTools 的一部分) 等命令行工具，在项目构建流程中自动完成子集化。

### d. 平滑化 FOUT，减少 CLS

`font-display: swap` 解决了内容可见性的问题，但它带来的 FOUT（字体切换时的“闪烁”）在视觉上仍然比较突兀，甚至可能因为字体度量（metrics）不同而引发布局偏移（CLS）。

我们可以通过 CSS 的 `@font-face` 描述符，**让备用字体尽可能地模拟最终 Web 字体的“骨架”**，从而让字体切换的过程更加平滑。

**核心思想**：调整备用字体的 `size-adjust`, `ascent-override`, `descent-override`, `line-gap-override` 属性，使其在字号、行高等关键度量上与目标 Web 字体对齐。

**如何实现**：
1.  选择一个广泛可用的本地字体作为备用（如 `Arial`）。
2.  使用工具（如 [Malte Ubl's font style matcher tool](https://meowni.ca/font-style-matcher/)）计算出 Web 字体和备用字体之间的度量差异，并生成调整代码。

```css
/* 目标 Web 字体 */
@font-face {
  font-family: 'Inter';
  src: url('/inter.woff2') format('woff2');
  font-display: swap;
}

/* 这是一个“伪造”的本地字体，用于调整其度量 */
@font-face {
  font-family: 'Inter-fallback';
  src: local('Arial'); /* 使用本地的 Arial 作为基础 */
  /* 以下为工具生成的调整值 */
  size-adjust: 97.38%;
  ascent-override: 92.56%;
  descent-override: 24.16%;
  line-gap-override: 0.00%;
}

/* 在 body 中使用时，将这个调整后的备用字体放在 Web 字体和通用字体族之间 */
body {
  font-family: 'Inter', 'Inter-fallback', sans-serif;
}
```

**效果**：通过这种方式，即使用户在 FOUT 期间看到的是备用字体，其占据的空间也和最终的 Web 字体几乎完全一样，这极大地**减少了 CLS**，并让字体切换的视觉效果**从“闪烁”变为平滑的“淡入”**。

## 4. 总结：字体优化最佳实践清单

1.  **格式优先**：始终优先使用 **WOFF2** 格式，并提供 WOFF/TTF 作为回退。
2.  **控制显示**：为所有 `@font-face` 规则添加 `font-display: swap;`，保证文本内容能最快地被用户看到。
3.  **预加载关键字体**：对首屏渲染必需的字体文件，使用 `<link rel="preload">` 进行预加载。
4.  **字体子集化 (最重要)**：根据你的实际用字需求，剔除字体文件中不必要的字符，这是减小体积最有效的手段。
5.  **字体托管**：将字体文件与你的其他静态资源一样，托管在 **CDN** 上以加速分发。
6.  **本地存储**：可以考虑将字体文件缓存在 `LocalStorage` 或 `IndexedDB` 中，但这是一种更激进的策略，适用于对性能要求极致的 PWA 等场景。
