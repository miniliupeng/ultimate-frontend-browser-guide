# 17-浏览器存储方案：Cookie、LocalStorage、IndexedDB

除了 HTTP 缓存，浏览器还提供了多种机制，允许网页在客户端（用户的浏览器）存储和访问数据。这些技术对于实现状态保持、个性化设置、离线应用等功能至关重要。

我们主要对比分析以下几种主流的存储方案：

## 1. Cookie

*   **诞生背景**：最早被设计出来用于**服务器端**识别和跟踪用户，以弥补 HTTP 协议的无状态性。
*   **核心特点**：
    *   **与服务器通信**：`Cookie` 的最大特点是，在**每次** HTTP 请求中，它都会被自动携带在请求头（Request Header）中发送给服务器。同样，服务器也可以通过响应头（Response Header）来设置或修改 `Cookie`。
    *   **体积小**：单个 `Cookie` 的大小不能超过 **4KB**，且单个域名下的 `Cookie` 数量也有限制（通常是 20 到 50 个）。
    *   **API 简单但原始**：通过 `document.cookie` 来读写，API 不够友好，需要手动封装。
*   **主要用途**：
    *   **会话管理**：存储用户的登录状态（Session ID）。
    *   **个性化设置**：存储用户偏好，如主题、语言等。
    *   **跟踪和分析**：广告联盟常用 `Cookie` 来跟踪用户的浏览行为。
*   **缺点**：
    *   **性能开销**：由于每次请求都会携带，如果 `Cookie` 中存储了大量非必要数据，会增加网络传输的开销。
    *   **安全性风险**：容易受到 CSRF（跨站请求伪造）攻击。为了防御此类攻击，必须合理设置其安全属性：
        *   `HttpOnly`：防止脚本窃取 `Cookie`。
        *   `Secure`：确保 `Cookie` 仅在 HTTPS 连接中传输。
        *   `SameSite`：控制 `Cookie` 在跨站请求中的发送行为，是防御 CSRF 的关键。现代浏览器默认值为 `Lax`，能有效防御大部分 CSRF 场景。

## 2. Web Storage API: `LocalStorage` & `SessionStorage`

Web Storage 是 HTML5 引入的，旨在提供比 `Cookie` 更强大、更易用的客户端存储方案。它分为 `LocalStorage` 和 `SessionStorage` 两种。

### a. `LocalStorage`

*   **核心特点**：
    *   **持久化存储**：除非用户手动清除浏览器数据或代码主动移除，否则 `LocalStorage` 中存储的数据会**永久有效**。
    *   **容量较大**：通常为 **5MB** 左右（因浏览器而异），远大于 `Cookie`。
    *   **纯客户端**：存储的数据**不会**自动发送给服务器，完全保留在客户端。
    *   **同源策略**：数据遵循同源策略，只有来自同一来源（协议、域名、端口）的页面才能访问。
    *   **API 友好**：提供了简单的键值对（key-value）API：`setItem()`, `getItem()`, `removeItem()`, `clear()`。
    *   **事件监听**：当同源的其他标签页修改 `LocalStorage` 时，当前标签页可以监听到 `storage` 事件，这为实现多标签页通信提供了一种便捷的机制。
*   **主要用途**：
    *   存储不常变化、且不敏感的数据，如用户的基础信息、全局配置等。
    *   作为离线应用的数据缓存。
*   **缺点**：
    *   **API 是同步的**：读写 `LocalStorage` 是一个同步操作，如果数据量过大，可能会阻塞主线程。
    *   **只能存储字符串**：如果要存储对象或数组，需要先用 `JSON.stringify()` 转换成字符串，读取时再用 `JSON.parse()` 解析回来。

### b. `SessionStorage`

`SessionStorage` 的 API 和特性与 `LocalStorage` 几乎完全相同，唯一的区别在于其**生命周期**。

*   **生命周期**：`SessionStorage` 中存储的数据仅在**当前会话（Session）**期间有效。
    *   “会话”指的是从用户打开一个标签页到关闭该标签页的整个过程。
    *   页面刷新或恢复（Restore）时，数据**依然存在**。
    *   **关闭标签页或浏览器后，数据会被清除**。
    *   在不同的标签页之间，即使是同源的页面，`SessionStorage` 也是**不共享**的。
*   **主要用途**：
    *   存储与当前页面会话相关的临时数据，如单页应用中的某些临时状态、表单中已填写的内容等。

## 3. IndexedDB

*   **诞生背景**：为了满足在浏览器中存储和查询**大量结构化数据**的需求，`LocalStorage` 这种简单的键值对存储已无法胜任。
*   **核心特点**：
    *   **非关系型数据库**：它是一个在浏览器中运行的、功能完备的**事务性、非关系型（NoSQL）数据库**。
    *   **容量巨大**：理论上容量没有严格上限，通常至少有数百 MB，具体取决于用户的可用磁盘空间。
    *   **异步 API**：所有数据库操作都是**异步**的，通过事件和回调函数来处理结果。这确保了它不会阻塞主线程，适合处理大数据。
    *   **支持事务**：保证了一系列操作的原子性，要么全部成功，要么全部失败。
    *   **支持索引**：可以为数据创建索引，从而实现快速的数据检索和查询。
    *   **存储多种类型**：可以直接存储 JavaScript 对象，无需手动序列化。
*   **主要用途**：
    *   **离线应用**：PWA（渐进式 Web 应用）的核心技术之一，用于在离线状态下存储和访问应用数据。
    *   **客户端数据仓库**：存储和管理大量的用户数据、应用状态或从服务器获取的数据缓存。
    *   **需要复杂查询功能的场景**。
*   **缺点**：
    *   **API 复杂**：相比 `LocalStorage`，`IndexedDB` 的原生 API 较为繁琐和底层，学习曲线较陡。通常需要借助第三方库（如 `Dexie.js`, `localForage`）来简化操作。

## 4. 总结与对比

| 特性             | `Cookie`                                 | `LocalStorage`                      | `SessionStorage`                        | `IndexedDB`                                     |
| ---------------- | ---------------------------------------- | ----------------------------------- | --------------------------------------- | ----------------------------------------------- |
| **主要用途**     | 与服务器通信，维持状态                   | 客户端持久化存储                    | 单个会话的临时存储                      | 客户端大型结构化数据存储                        |
| **与服务器交互** | 每次请求自动携带                         | 否                                  | 否                                      | 否                                              |
| **生命周期**     | 可设置过期时间，否则随浏览器关闭而失效   | 永久有效，除非手动清除              | 当前会话期间有效（标签页关闭即清除）      | 永久有效，除非手动清除                          |
| **容量大小**     | ~4KB                                     | ~5MB                                | ~5MB                                    | 巨大（通常 > 250MB）                            |
| **API**          | `document.cookie` (不友好)               | 同步 API (`setItem`, `getItem`)     | 同步 API (`setItem`, `getItem`)         | 异步 API (事务、索引)                           |
| **数据类型**     | 字符串                                   | 字符串                              | 字符串                                  | 任意 JavaScript 对象                          |
| **同源跨标签页共享** | 是                                       | 是                                  | **否**                                  | 是                                              |

**如何选择？**
*   需要与服务器端进行状态同步，或者需要兼容老旧浏览器 -> **`Cookie`**
*   需要存储少量、不敏感的、持久化的配置信息 -> **`LocalStorage`**
*   需要存储仅在当前标签页有效的临时数据 -> **`SessionStorage`**
*   需要存储大量、复杂的结构化数据，并可能需要进行查询，或用于离线应用 -> **`IndexedDB`**

## 5. 补充：Cache API (Service Worker Cache)

除了上述用于存储**数据**的 API 外，现代浏览器还提供了一个专门用于**缓存网络请求响应**的存储机制——`Cache API`。

*   **主要用途**：通常与 `Service Worker` 配合使用，用于拦截网络请求，并将响应对象（如 JS/CSS 文件、图片、API 返回的 JSON）存储起来。
*   **核心优势**：它是实现 PWA (渐进式 Web 应用) **离线访问能力**的关键技术。通过 `Cache API`，开发者可以编程控制资源的缓存策略，让应用在没有网络连接时也能从缓存中读取内容并正常工作。

因此，在构建复杂的离线应用时，通常是 **`IndexedDB` (存储结构化数据) + `Cache API` (缓存网络资源)** 协同工作。
