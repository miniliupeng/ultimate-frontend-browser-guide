# 10-TCP/IP协议族：TCP与UDP

要深入理解 Web 网络，我们必须下沉到 HTTP 协议之下的传输层，了解支撑着整个互联网数据传输的两个核心协议：TCP 和 UDP。它们都属于 TCP/IP 协议族的一部分。

## 1. TCP/IP 协议分层模型

TCP/IP 协议族通常被划分为一个四层模型，每一层都负责不同的功能：

1.  **应用层 (Application Layer)**
    *   **职责**：定义应用程序之间如何交换信息。
    *   **常见协议**：`HTTP`, `HTTPS`, `FTP`, `DNS`, `WebSocket`。这是我们前端开发者最常接触的一层。

2.  **传输层 (Transport Layer)**
    *   **职责**：负责在**两个主机**的**进程**之间提供端到端的通信服务。
    *   **核心协议**：`TCP` 和 `UDP`。

3.  **网络层 (Network Layer / Internet Layer)**
    *   **职责**：负责将数据包从一个主机路由到另一个主机，实现**主机到主机**的通信。
    *   **核心协议**：`IP` (Internet Protocol)。IP 协议为数据包加上 IP 地址（源地址和目标地址），确保数据能被网络中的路由器正确转发。

4.  **网络接口层 (Network Interface Layer / Link Layer)**
    *   **职责**：负责在物理网络（如以太网、Wi-Fi）上传输数据帧。

数据发送时，会自上而下（从应用层到网络接口层）进行**封装**；接收时，则会自下而上进行**解封装**。

## 2. TCP (Transmission Control Protocol) - 传输控制协议

TCP 是一个**面向连接的、可靠的、基于字节流**的传输层协议。HTTP/1.x 和 HTTP/2 都构建于 TCP 之上。

### a. 核心特点

*   **可靠性**：TCP 通过多种机制确保数据能够**完整、有序、无误**地从发送方传输到接收方。
    *   **序列号与确认应答 (ACK)**：发送的每个数据包都有一个序列号，接收方收到后会返回一个确认号，告诉发送方“我已经收到这个包了”。
    *   **超时重传**：如果发送方在一定时间内没有收到某个数据包的确认应答，就会重新发送该数据包。
    *   **流量控制**：通过“滑动窗口”机制，接收方可以告知发送方自己还能接收多少数据，防止发送方过快地发送数据导致接收方缓冲区溢出。
    *   **拥塞控制**：当网络出现拥堵时，TCP 会主动减慢数据发送的速率，以缓解网络压力。
*   **面向连接**：在数据传输之前，必须通过**三次握手**建立一个稳定的连接；数据传输结束后，需要通过**四次挥手**来断开连接。
*   **全双工通信**：连接一旦建立，通信双方可以同时进行数据的发送和接收。
*   **队头阻塞 (Head-of-Line Blocking)**：TCP 的严格有序性要求，如果一个序列号靠前的数据包（例如第 3 个包）因为网络问题丢失或延迟，那么即使它后面的数据包（第 4、5、6 个包）已经到达接收方，接收方也必须等待第 3 个包重传并到达后，才能将整个有序的数据流交付给上层应用。这个过程就像队伍最前面的人不动，后面的人也只能等着，即使他们已经准备好了。在 HTTP/2 的多路复用场景下，这会导致一个 TCP 包的丢失阻塞所有并发的 HTTP 请求。

### b. 三次握手 (Three-Way Handshake) - 建立连接

三次握手的目的是同步双方的序列号和确认号，并交换 TCP 窗口大小等信息，确保双方都做好了收发数据的准备。

**为什么是三次，不是两次？**
三次握手的核心在于，**确保通信双方都明确知晓，自己和对方的‘发送’与‘接收’能力都处于正常状态**。
*   **两次握手的问题**：如果只有两次握手，服务器发出 `SYN+ACK` 后就认为连接已建立，但此时服务器并不知道客户端是否收到了这个包。如果这个包在网络中丢失，客户端会认为连接失败，而服务器则会一直等待，造成资源浪费。
*   **三次握手的必要性**：第三次握手（客户端发送 `ACK`）就是为了向服务器证明：“我收到了你的确认，我的接收能力没问题，现在我们可以开始通信了。”

1.  **第一次握手 (SYN)**：客户端向服务器发送一个 `SYN` (Synchronize Sequence Numbers) 包，其中包含一个初始序列号 `x`。此时客户端进入 `SYN_SENT` 状态。
2.  **第二次握手 (SYN+ACK)**：服务器收到 `SYN` 包后，返回一个 `SYN+ACK` 包。其中 `ACK` (Acknowledgment) 号为 `x+1`，表示已收到客户端的包；同时服务器也生成自己的初始序列号 `y`。此时服务器进入 `SYN_RCVD` 状态。
3.  **第三次握手 (ACK)**：客户端收到服务器的 `SYN+ACK` 包后，再发送一个 `ACK` 包给服务器，其中 `ACK` 号为 `y+1`。此时客户端进入 `ESTABLISHED` 状态。服务器收到这个 `ACK` 包后，也进入 `ESTABLISHED` 状态，连接建立成功。

### c. 四次挥手 (Four-Way Handshake) - 断开连接

由于 TCP 是全双工的，连接的断开需要双方各自关闭自己的发送通道。

1.  **第一次挥手**：客户端决定关闭连接，向服务器发送一个 `FIN` (Finish) 包。
2.  **第二次挥手**：服务器收到 `FIN` 包后，先发送一个 `ACK` 包，表示“我知道你要关闭了”。此时，从客户端到服务器的通道关闭，但服务器可能还有数据要发送给客户端，所以服务器仍然可以向客户端发送数据。
3.  **第三次挥手**：服务器处理完所有待发送的数据后，也向客户端发送一个 `FIN` 包，表示“我也准备关闭了”。
4.  **第四次挥手**：客户端收到服务器的 `FIN` 包后，发送一个 `ACK` 包作为确认。服务器收到这个 `ACK` 后，连接正式关闭。客户端会等待一段时间（2MSL）以确保服务器收到了最后的 `ACK`，然后也关闭连接。

> **TIME_WAIT 状态的意义**
> 在第四次挥手后，客户端会进入 `TIME_WAIT` 状态并等待 2MSL（最大报文段生存时间），这是一个非常重要的机制：
> 1.  **保证最后的 ACK 能成功到达服务器**：如果这个 ACK 丢失，服务器会超时重传 FIN。客户端等待 2MSL，就能在此期间响应该重传，并再次发送 ACK，确保服务器能正常关闭。
> 2.  **防止已失效的报文段干扰新连接**：等待 2MSL 可以确保本次连接中产生的所有报文段都从网络中自然消失，不会出现在下一个使用相同端口的新连接中。

## 3. UDP (User Datagram Protocol) - 用户数据报协议

UDP 是一个**无连接的、不可靠的、面向数据报**的传输层协议。

### a. 核心特点

*   **不可靠性**：UDP 不提供任何可靠性保证。它只负责尽力而为地将数据包（数据报）发送出去，但不保证它们是否会到达、是否按顺序到达、或者是否完整无误。
*   **无连接**：数据发送前无需建立连接（没有握手），也无需在结束后断开连接。
*   **开销小、速度快**：由于没有复杂的可靠性机制（如确认、重传、流量控制等），UDP 的协议头部非常简单，处理速度极快，网络开销小。
*   **面向数据报**：UDP 一次发送一个完整的数据报，保留了消息的边界。接收方要么接收到完整的消息，要么什么也接收不到。

## 4. TCP vs UDP - 总结与对比

| 特性     | TCP (传输控制协议)                       | UDP (用户数据报协议)               |
| -------- | ---------------------------------------- | ---------------------------------- |
| **连接** | 面向连接 (三次握手/四次挥手)             | 无连接                             |
| **可靠性** | **可靠** (确认、重传、拥塞控制)            | **不可靠** (尽力而为)              |
| **速度** | 较慢                                     | 较快                               |
| **开销** | 较大 (协议头复杂)                        | 较小 (协议头简单)                  |
| **流模式** | 面向字节流 (数据无边界)                  | 面向数据报 (保留消息边界)          |
| **应用场景** | **可靠性要求高**的场景：<br/>- Web (HTTP/HTTPS)<br/>- 文件传输 (FTP)<br/>- 电子邮件 (SMTP) | **实时性要求高、允许少量丢包**的场景：<br/>- 视频/音频流媒体<br/>- 在线游戏<br/>- DNS 查询<br/>- **HTTP/3 (QUIC)** |

**一个关键点**：最新的 HTTP/3 协议为了解决 TCP 的队头阻塞问题，选择**基于 UDP** 构建了新的可靠传输协议 QUIC。这充分体现了在现代网络环境下，有时需要“绕过”TCP 的严格可靠性，在应用层根据自身需求“定制”可靠性，以换取更高的性能和灵活性。
