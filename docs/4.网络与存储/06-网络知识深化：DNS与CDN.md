# 15-网络知识深化：DNS与CDN

本章我们将深入探讨两个与前端性能和开发实践紧密相关的高阶网络主题：DNS 预解析与 CDN 工作原理。

## 1. 资源加载提示 (Resource Hints)

浏览器提供了一系列的 `<link>` 类型，让开发者可以向浏览器提供“提示”，精细地控制资源的解析、连接和加载时机，从而优化关键渲染路径。

### a. DNS 预解析 (DNS Prefetching)

我们在“URL输入到页面展现的全过程”中了解到，DNS 解析是将域名转换为 IP 地址的过程，这个过程可能会消耗几十到上百毫秒的时间。如果我们的主站 `a.com` 依赖了多个不同域名的静态资源（例如 `static.b.com`）或 API（例如 `api.c.com`），那么浏览器在请求这些资源时，需要依次对每个新域名进行 DNS 查询，从而累积了显著的延迟。

**DNS 预解析**是一种浏览器优化技术，它允许浏览器在后台**并行地、提前地**解析这些未来可能会用到的域名，将解析结果缓存起来。这样，当后续真正需要请求这些域名下的资源时，就可以跳过 DNS 查询阶段，直接建立 TCP 连接，从而减少延迟，加快页面加载速度。

**如何实现？**

实现 DNS 预解析非常简单，只需在 HTML 页面的 `<head>` 标签中添加一个 `<link>` 标签即可：

```html
<head>
  <!-- 预解析静态资源域名 -->
  <link rel="dns-prefetch" href="//static.b.com">

  <!-- 预解析 API 域名 -->
  <link rel="dns-prefetch" href="//api.c.com">
</head>
```
**注意事项：**
*   `dns-prefetch` 只会对**跨域**的域名生效，对于当前主域名及其子域名，浏览器会自动进行解析，无需手动设置。
*   对于 HTTPS 页面，预解析会同时完成 DNS 查询和 TCP 握手，甚至 TLS 握手。这个增强版的 `dns-prefetch` 也被称为 
**Preconnect**。如果你非常确定很快就会用到某个域名，使用 `preconnect` 会更激进、效果更好：
    ```html
    <link rel="preconnect" href="//api.c.com">
    ```
*   不要滥用。预解析过多的域名会消耗用户的网络和 CPU 资源，应只对那些一定会用到的、关键的跨域域名进行设置。

### b. Preconnect

`preconnect` 是一个更激进的指令，它不仅会完成 DNS 解析，还会进一步建立 TCP 连接甚至进行 TLS 握手。

*   **语法**: `<link rel="preconnect" href="//api.c.com">`
*   **作用**: 如果你非常确定很快就会请求某个跨域域名下的资源，使用 `preconnect` 可以消除后续请求中的 DNS、TCP 和 TLS 连接建立的全部时间开销。
*   **注意事项**:
    *   `preconnect` 包含了 `dns-prefetch` 的全部功能。因此，如果你对一个域名使用了 `preconnect`，就**无需**再对同一个域名使用 `dns-prefetch`。
    *   不要滥用。预连接过多的域名会消耗用户的网络和 CPU 资源，应只对那些一定会用到的、关键的跨域域名进行设置。

### c. Preload

*   **语法**: `<link rel="preload" href="/critical.js" as="script">`
*   **作用**: 告知浏览器，这是一个**当前页面导航周期内一定会用到**的关键资源，请**立即以高优先级下载**它，但**不要执行**。
*   **核心优势**:
    *   **解耦了下载与执行**：对于脚本，`preload` 会下载文件，但不会像 `<script>` 标签那样立即解析和执行，从而避免了阻塞渲染。当你在代码中需要这个脚本时（例如通过动态创建 `<script>` 标签），它已经存在于缓存中，可以立即执行。
    *   **提升优先级**：可以提升一些隐藏在 CSS 或 JS 文件深处的关键资源（如字体、背景图）的下载优先级。
*   **`as` 属性至关重要**: `as` 属性告知浏览器正在加载的资源类型，这有助于浏览器正确地设置请求优先级、内容安全策略（CSP）和 `Accept` 请求头。

### d. Prefetch

*   **语法**: `<link rel="prefetch" href="/next-page.js">`
*   **作用**: 告知浏览器，这是一个用户在**未来导航中（例如访问下一个页面）可能会用到**的资源。浏览器会在**空闲时**以**低优先级**下载该资源。
*   **核心优势**: 加速后续页面的加载体验。当用户点击链接跳转到下一个页面时，所需的某些资源可能已经存在于 HTTP 缓存中了。
*   **适用场景**: 预加载用户最有可能访问的下一个页面的资源、或者单页应用中下一个路由所需的组件。

### e. Prerender

*   **语法**: `<link rel="prerender" href="/next-page.html">`
*   **作用**: 这是一个重量级的提示。它会指示浏览器在后台**完整地加载并渲染**一个页面及其所有子资源。
*   **核心优势**: 如果用户最终导航到该页面，页面几乎可以瞬时呈现。
*   **缺点**: 资源消耗巨大，应只在你有极高把握用户会访问下一个页面时才使用。

### f. Resource Hints 对比

| 指令          | 作用范围         | 优先级 | 执行时机         | 适用场景                               |
| ------------- | ---------------- | -------- | ---------------- | -------------------------------------- |
| `dns-prefetch`| 跨域域名         | 最低     | 空闲时           | 预解析未来会用到的多个第三方域名       |
| `preconnect`  | 跨域域名         | 较高     | 立即             | 预连接很快会用到的关键 API 或 CDN 域名 |
| `preload`     | **当前页面**资源 | 最高     | 立即             | 加载当前页面一定会用到的关键资源       |
| `prefetch`    | **未来页面**资源 | 最低     | 空闲时           | 预加载下一个页面的资源                 |
| `prerender`   | **未来页面**     | 最低     | 空闲时           | 极高概率用户会访问的下一个完整页面     |

## 2. CDN 工作原理

**CDN (Content Delivery Network, 内容分发网络)** 是构建在现有互联网之上的一个智能虚拟网络。它的核心思想是**将源站的资源缓存到全球各地的“边缘节点（Edge Nodes）”服务器上**，让用户可以**就近**获取所需内容，从而避免网络拥堵、提高访问速度和稳定性。

### a. CDN 如何实现加速？

1.  **智能 DNS 解析**：
    *   当用户请求一个使用了 CDN 的域名时（例如 `static.b.com`），这个域名的 DNS 解析请求会被 CDN 的**智能 DNS 服务器**接管。
    *   智能 DNS 服务器会根据用户的**地理位置、运营商网络、节点负载情况**等因素，返回一个**离用户最近、访问速度最快**的**边缘节点**的 IP 地址。
2.  **边缘节点缓存**：
    *   用户的浏览器随后会向这个边缘节点发起资源请求。
    *   如果边缘节点**已经缓存**了该资源，并且缓存未过期，它会直接将资源返回给用户，完成一次高速的访问。
    *   如果边缘节点**没有缓存**该资源，或者缓存已过期，它会代表用户向**源站**发起请求，获取最新的资源。这个过程称为“**回源**”。
    *   边缘节点从源站获取到资源后，会将其**缓存**在自己本地，然后再返回给用户。这样，下一个访问该节点的附近用户就可以直接从缓存中受益。

### b. CDN 的价值

*   **加速**：核心价值。通过就近访问和智能路由，大幅缩短了数据传输的物理距离和网络延迟。
*   **高可用性**：CDN 的多节点架构提供了天然的冗余。即使某个节点出现故障，请求也可以被自动调度到其他健康的节点。
*   **分担源站压力**：绝大多数静态资源请求都由 CDN 的边缘节点处理，源站服务器只需应对少量的回源请求和动态内容请求，大大降低了负载。
*   **安全防护**：许多 CDN 服务商还提供 DDoS 攻击防护、WAF (Web Application Firewall) 等安全功能。

### c. 最佳实践

1.  **静态与动态资源分离**：
    *   将网站的资源分为两类：**静态资源**（如 CSS, JS, 图片, 字体）和**动态资源**（如 HTML, API 数据）。
    *   为静态资源单独配置一个域名（例如 `static.yourdomain.com`），并将其完全交由 CDN 进行缓存和分发。
    *   动态资源则由源站服务器处理，以保证内容的实时性。

2.  **合理配置缓存策略**：
    *   在源站服务器上，为静态资源设置**非常长**的 `Cache-Control: max-age`（例如一年 `max-age=31536000`）。
    *   这样可以最大化地利用 CDN 边缘节点缓存和浏览器本地缓存，最大限度地减少回源。

3.  **通过文件名进行版本控制**：
    *   由于静态资源的缓存时间设置得很长，当我们需要更新资源时（例如发布新版本的 JS 文件），不能直接覆盖同名文件。
    *   最佳实践是在文件名中加入**哈希值**或**版本号**，例如 `main.d2c4b8.js`。
    *   当文件内容改变时，文件名（哈希）也会改变。这样，浏览器在请求新的 HTML 时，就会请求一个全新的 URL，从而自然地绕开了旧版本的缓存，实现了无缝更新。现代化的构建工具（如 Webpack, Vite）都内置了此功能。

4.  **动静结合与 API 加速**：
    *   对于一些非高度个性化的动态内容（例如新闻列表 API），也可以利用 CDN 进行**短时间的缓存**（例如 1-5 分钟），这被称为“动态内容加速”，可以有效缓解突发流量下对源站 API 服务器的冲击。

5.  **选择合适的 CDN 服务商**：
    *   根据你的主要用户群体地理位置，选择在相应区域拥有丰富节点的服务商。
    *   评估其提供的功能，如 HTTP/3 支持、图片优化、安全防护等。
